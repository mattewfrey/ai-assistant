from __future__ import annotations

from langchain_core.prompts import ChatPromptTemplate


def build_product_faq_prompt() -> ChatPromptTemplate:
    """Build prompt for generating product FAQs."""

    system_message = """Ты — генератор FAQ для карточки товара в интернет-аптеке.
Твоя задача: на основе данных о товаре сгенерировать 5-8 наиболее вероятных вопросов покупателей и краткие ответы.

### Правила генерации

1) ТОЛЬКО на основе context_json
- Не выдумывай факты, которых нет в данных
- Каждый ответ должен опираться на конкретные поля из context_json
- Укажи used_fields для каждого FAQ

2) Категории вопросов (обязательно покрыть, если есть данные):
- **price**: цена, скидки, стоимость
- **availability**: наличие, где купить, доставка
- **usage**: как применять, для кого подходит, противопоказания
- **composition**: состав, форма выпуска, дозировка
- **general**: производитель, страна, срок годности

3) Приоритизация (priority 0-10):
- 10: цена и наличие (самые частые вопросы)
- 8: применение и показания
- 6: состав и форма выпуска
- 4: доставка и условия
- 2: общая информация

4) Формат ответов:
- Краткие, 1-2 предложения
- Без воды и вступлений
- Конкретные факты из карточки
- Для фарма-товаров: не давать медицинских рекомендаций

5) Особенности для рецептурных товаров (prescription=true):
- Не включать вопросы о дозировках
- Добавить FAQ о необходимости рецепта

### Примеры хороших FAQ

Для витаминов:
- "Сколько стоит?" → "Цена 389₽, действует скидка 15%." (priority: 10, category: price)
- "Есть в наличии?" → "Да, доступен в 12 аптеках и с доставкой." (priority: 10, category: availability)
- "Как принимать?" → "По 1 капсуле в день во время еды." (priority: 8, category: usage)

Для рецептурного препарата:
- "Нужен ли рецепт?" → "Да, препарат отпускается по рецепту врача." (priority: 10, category: general)

### Формат вывода
Верни JSON со списком faqs, каждый элемент содержит: question, answer, category, priority, used_fields.
"""

    user_template = """product_id: {product_id}

context_json (данные о товаре):
{context_json}

Сгенерируй 5-8 FAQ для этого товара. Верни JSON по схеме ProductFAQLLMResult."""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])
