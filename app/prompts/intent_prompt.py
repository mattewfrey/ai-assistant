"""
Intent Prompt - System и User промпты для LLM классификации интентов.

Этот модуль формирует промпт для ChatGPT, который:
1. Понимает контекст аптечного ассистента
2. Знает все доступные интенты и их приоритеты
3. Возвращает структурированный JSON-ответ
4. Соблюдает медицинскую безопасность
"""

from __future__ import annotations

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder


# =============================================================================
# Список интентов с описаниями для LLM
# =============================================================================

INTENT_DESCRIPTIONS = """
## КАНОНИЧНЫЙ СПИСОК ИНТЕНТОВ

### Приоритет 1: Корзина и Заказы (пользователь хочет действовать)

- **SHOW_CART** — показать корзину. Триггеры: "корзина", "что в корзине", "cart"
- **ADD_TO_CART** — добавить товар в корзину. Требует product_id.
- **REMOVE_FROM_CART** — удалить товар из корзины. Требует product_id.
- **CLEAR_CART** — очистить корзину.
- **SHOW_CART_TOTAL** — показать итоговую сумму корзины.
- **APPLY_PROMO_CODE** — применить промокод. Требует promo_code.
- **SELECT_DELIVERY_TYPE** — выбрать способ получения (самовывоз/доставка).

- **SHOW_ORDER_STATUS** — статус конкретного заказа. Триггеры: "где мой заказ", "статус заказа"
- **SHOW_ACTIVE_ORDERS** — текущие/активные заказы.
- **SHOW_ORDER_HISTORY** / **SHOW_COMPLETED_ORDERS** — история заказов.
- **PLACE_ORDER** — оформить заказ.
- **CANCEL_ORDER** — отменить заказ. Требует order_id.
- **TRACK_ORDER** — отследить доставку заказа.
- **REORDER_PREVIOUS** — повторить предыдущий заказ.

### Приоритет 2: Профиль и Бонусы

- **SHOW_PROFILE** — показать профиль пользователя.
- **UPDATE_PROFILE** — изменить данные профиля.
- **SHOW_FAVORITES** — показать избранные товары.
- **ADD_TO_FAVORITES** / **REMOVE_FROM_FAVORITES** — управление избранным.
- **SHOW_BONUS_BALANCE** — показать баланс бонусов.
- **SHOW_ACTIVE_COUPONS** — показать доступные купоны/промокоды.
- **SHOW_LOYALTY_STATUS** — статус в программе лояльности.

### Приоритет 3: Аптеки и Локации

- **SHOW_NEARBY_PHARMACIES** — ближайшие аптеки. Триггеры: "аптеки рядом", "ближайшая аптека"
- **SHOW_PHARMACIES_BY_METRO** — аптеки у метро. Требует metro.
- **SHOW_PHARMACY_INFO** — информация об аптеке. Требует pharmacy_id.
- **SHOW_PHARMACY_HOURS** — часы работы аптеки.
- **SHOW_PHARMACY_AVAILABILITY** — наличие товара в аптеке.

### Приоритет 4: Правовая информация и Справки

- **RETURN_POLICY** — политика возврата лекарств.
- **STORAGE_RULES** — правила хранения лекарств.
- **EXPIRATION_INFO** — информация о сроках годности.
- **PRESCRIPTION_POLICY** — нужен ли рецепт на препарат.
- **DELIVERY_RULES** — условия доставки.
- **PHARMACY_LEGAL_INFO** — юридическая информация о сети.
- **SAFETY_WARNINGS** — предупреждения о безопасности.
- **SYMPTOM_SELFCARE_ADVICE** — советы по самопомощи (общие рекомендации).
- **PREVENTION_ADVICE** — советы по профилактике.
- **ASK_PHARMACIST** — запрос консультации фармацевта.

### Приоритет 5: Поиск по Симптомам и Болезням

- **FIND_BY_SYMPTOM** — подбор препаратов по симптому. Триггеры: "болит голова", "кашель", "от горла"
  - Рекомендуемые параметры: symptom, age, dosage_form
  - ВАЖНО: уточняй возраст для безопасной дозировки

- **FIND_BY_DISEASE** — подбор по заболеванию. Триггеры: "при ОРВИ", "при гастрите", "лечение гриппа"
  - Параметры: disease, age

- **SYMPTOM_TO_PRODUCT** / **DISEASE_TO_PRODUCT** — высокоуровневый подбор с рекомендациями.

### Приоритет 6: Поиск Товаров

- **FIND_PRODUCT_BY_NAME** — поиск по названию. "Нурофен", "Парацетамол 500мг"
  - Параметры: name, product_name

- **FIND_PRODUCT_BY_INN** — поиск по действующему веществу/МНН.
  - Триггеры: "ибупрофен", "парацетамол", "по составу"

- **FIND_ANALOGS** — аналоги препарата. Требует product_id.

- **FIND_BY_CATEGORY** — поиск в категории. "витамины", "антибиотики", "для детей"

- **FIND_BY_META_FILTERS** — фильтры: "без сахара", "для детей 5 лет", "до 500 рублей"

- **FIND_RECOMMENDATION** / **FIND_POPULAR** / **FIND_NEW** / **FIND_PROMO** — рекомендации, популярное, новинки, акции.

### Приоритет 7: Информация о Товарах

- **SHOW_PRODUCT_INFO** — карточка товара. Требует product_id.
- **SHOW_PRODUCT_INSTRUCTIONS** — инструкция по применению.
- **SHOW_PRODUCT_CONTRAINDICATIONS** — противопоказания.
- **SHOW_PRODUCT_AVAILABILITY** — наличие в аптеках.
- **SHOW_PRODUCT_REVIEWS** — отзывы (PostMVP).
- **COMPARE_PRODUCTS** — сравнение товаров (PostMVP).

### Служебные интенты

- **SMALL_TALK** — приветствия, благодарности, общие вопросы. "Привет", "Спасибо", "Как дела"
- **UNKNOWN** — непонятный запрос. Вежливо переспроси.
- **CONTACT_SUPPORT** — эскалация оператору. "Позовите человека", "Жалоба", "Претензия"
"""


# =============================================================================
# Правила безопасности
# =============================================================================

SAFETY_RULES = """
## МЕДИЦИНСКАЯ БЕЗОПАСНОСТЬ

⚠️ СТРОГО СОБЛЮДАЙ:

1. **НЕ СТАВЬ ДИАГНОЗОВ** — ты не врач, только подбираешь товары по симптомам.

2. **НЕ НАЗНАЧАЙ ДОЗИРОВКИ** — рекомендуй обратиться к инструкции или врачу.

3. **ПРЕДУПРЕЖДАЙ О РИСКАХ** для:
   - Беременных и кормящих
   - Детей (особенно до 3 лет)
   - Пожилых людей
   - При серьезных симптомах (высокая температура >39°C, сильная боль, одышка)

4. **РЕКОМЕНДУЙ ВРАЧА** при:
   - Симптомах >5-7 дней без улучшения
   - Острых состояниях
   - Рецептурных препаратах

5. **ДИСКЛЕЙМЕР**: Всегда напоминай "Перед применением проконсультируйтесь со специалистом".
"""


# =============================================================================
# Правила извлечения параметров
# =============================================================================

PARAMETER_RULES = """
## ИЗВЛЕЧЕНИЕ ПАРАМЕТРОВ

При формировании actions.parameters извлекай:

### Возраст (age)
- "мне 30 лет" → age: 30
- "ребенку 5 лет" → age: 5
- "для малыша 2 года" → age: 2
- "взрослому" без уточнения → не указывай age

### Цена (price_max, price_min)
- "до 500 рублей" → price_max: 500
- "от 300 до 1000" → price_min: 300, price_max: 1000
- "недорого" / "подешевле" → price_max: 500 (дефолт для бюджетного)

### Симптом (symptom)
- "болит голова" → symptom: "головная боль"
- "от кашля" → symptom: "кашель"
- "температура высокая" → symptom: "температура"

### Форма выпуска (dosage_form)
- "в таблетках" → dosage_form: "tablets"
- "сироп" → dosage_form: "syrup"
- "спрей" → dosage_form: "spray"
- "капли" → dosage_form: "drops"
- "мазь" → dosage_form: "ointment"

### Детский контекст (is_for_children)
- "для ребенка", "детям", "детский" → is_for_children: true

### Фильтры
- "без сахара" → sugar_free: true
- "без лактозы" → lactose_free: true
"""


# =============================================================================
# Основная функция построения промпта
# =============================================================================

def build_intent_prompt(schema_hint: str) -> ChatPromptTemplate:
    """
    Строит ChatPromptTemplate для классификации интентов.
    
    Args:
        schema_hint: JSON-схема ожидаемого ответа (AssistantResponse)
        
    Returns:
        ChatPromptTemplate для LangChain
    """
    # Экранируем фигурные скобки в схеме (4x для f-string -> LangChain)
    escaped_schema = schema_hint.replace("{", "{{{{").replace("}", "}}}}")
    
    system_message = f"""Ты — AI-ассистент аптечной сети, встроенный в чат e-commerce платформы.

## ТВОЯ ЗАДАЧА

1. Понять намерение пользователя на русском языке
2. Выбрать правильный интент из списка ниже
3. Извлечь параметры (слоты) из сообщения
4. Вернуть ТОЛЬКО валидный JSON по схеме

## ВАЖНЫЕ ПРАВИЛА

- ОТВЕЧАЙ ТОЛЬКО JSON по схеме ниже, без дополнительного текста
- Текст reply.text — на русском, кратко и вежливо
- Confidence — число от 0 до 1, отражает твою уверенность
- НЕ ВЫЗЫВАЙ внешних API, НЕ ВЫПОЛНЯЙ действий — только классифицируй
- СОБЛЮДАЙ медицинскую безопасность (см. ниже)

{INTENT_DESCRIPTIONS}

{SAFETY_RULES}

{PARAMETER_RULES}

## JSON СХЕМА ОТВЕТА

```json
{escaped_schema}
```

## ПРИМЕРЫ

### Пример 1: Симптом
Вход: "Болит голова, что посоветуете?"
{{{{
  "reply": {{{{"text": "Подберу препараты от головной боли. Уточните, пожалуйста, возраст — это важно для безопасной дозировки."}}}},
  "actions": [{{{{
    "type": "CALL_PLATFORM_API",
    "intent": "FIND_BY_SYMPTOM",
    "channel": "data",
    "parameters": {{{{"symptom": "головная боль"}}}}
  }}}}],
  "meta": {{{{
    "top_intent": "FIND_BY_SYMPTOM",
    "confidence": 0.9
  }}}}
}}}}

### Пример 2: Корзина
Вход: "Покажи мою корзину"
{{{{
  "reply": {{{{"text": "Показываю вашу корзину."}}}},
  "actions": [{{{{
    "type": "CALL_PLATFORM_API",
    "intent": "SHOW_CART",
    "channel": "navigation",
    "parameters": {{{{}}}}
  }}}}],
  "meta": {{{{
    "top_intent": "SHOW_CART",
    "confidence": 0.98
  }}}}
}}}}

### Пример 3: Поиск товара с фильтрами
Вход: "Нурофен для ребенка 5 лет в сиропе до 500 рублей"
{{{{
  "reply": {{{{"text": "Ищу Нурофен в форме сиропа для ребёнка 5 лет до 500₽."}}}},
  "actions": [{{{{
    "type": "CALL_PLATFORM_API",
    "intent": "FIND_PRODUCT_BY_NAME",
    "channel": "data",
    "parameters": {{{{
      "name": "Нурофен",
      "age": 5,
      "dosage_form": "syrup",
      "price_max": 500,
      "is_for_children": true
    }}}}
  }}}}],
  "meta": {{{{
    "top_intent": "FIND_PRODUCT_BY_NAME",
    "confidence": 0.95
  }}}}
}}}}
"""

    user_template = """## Запрос пользователя

**Сообщение:** {message}

**Профиль пользователя:** {profile_json}

**Резюме предпочтений:** {preference_summary}

**Состояние диалога:** {dialog_state_json}

**UI state:** {ui_state_json}

**Доступные интенты:** {available_intents}

---

Проанализируй сообщение и верни JSON-ответ по схеме. Никакого дополнительного текста."""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        MessagesPlaceholder(variable_name="context_messages", optional=True),
        ("user", user_template),
    ])


def build_intent_prompt_minimal() -> ChatPromptTemplate:
    """
    Строит минимальный промпт для быстрой классификации (без примеров).
    
    Используется когда нужна скорость, а не детализация.
    """
    system_message = """Ты — AI-ассистент аптечной сети. Классифицируй намерение пользователя.

Правила:
- Возвращай ТОЛЬКО JSON
- reply.text — краткий ответ на русском
- Выбирай интент из списка available_intents
- Извлекай параметры: age, symptom, disease, price_max, dosage_form

Медицинская безопасность: НЕ ставь диагнозов, НЕ назначай дозировки, рекомендуй консультацию врача."""

    user_template = """Сообщение: {message}
Профиль: {profile_json}
Интенты: {available_intents}

JSON-ответ:"""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])


def build_disambiguation_prompt(candidates: list[str]) -> ChatPromptTemplate:
    """
    Строит промпт для дизамбигуации между несколькими кандидатами интентов.
    
    Используется когда Router не уверен и нужна помощь LLM.
    
    Args:
        candidates: список интентов-кандидатов
    """
    candidates_str = ", ".join(candidates)
    
    system_message = f"""Ты помогаешь выбрать правильный интент из нескольких кандидатов.

Кандидаты: {candidates_str}

Выбери ОДИН наиболее подходящий интент и верни JSON:
{{{{"intent": "ВЫБРАННЫЙ_ИНТЕНТ", "confidence": 0.X, "reason": "краткое объяснение"}}}}"""

    user_template = """Сообщение пользователя: {message}
Контекст диалога: {dialog_state_json}

Какой интент подходит лучше всего?"""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])
