"""
Intent Prompt - System –∏ User –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–Ω—Ç–µ–Ω—Ç–æ–≤.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è ChatGPT, –∫–æ—Ç–æ—Ä—ã–µ:
1. –ü–æ–Ω–∏–º–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–ø—Ç–µ—á–Ω–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
2. –ó–Ω–∞—é—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã –∏ –∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
3. –í–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–æ—Ç–≤–µ—Ç (LLMIntentResult)
4. –°–æ–±–ª—é–¥–∞—é—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤:
- build_intent_prompt() - –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- build_disambiguation_prompt() - –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ Router'–∞
- build_slot_extraction_prompt() - –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ–º –∏–Ω—Ç–µ–Ω—Ç–µ
"""

from __future__ import annotations

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

from ..intents import IntentType


# =============================================================================
# –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–Ω—Ç–æ–≤ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
# =============================================================================

INTENT_CATALOG = """
## –ü–û–õ–ù–´–ô –ö–ê–¢–ê–õ–û–ì –ò–ù–¢–ï–ù–¢–û–í

–í—ã–±–∏—Ä–∞–π –†–û–í–ù–û –û–î–ò–ù –∏–Ω—Ç–µ–Ω—Ç –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî –≤—ã–±–∏—Ä–∞–π —Å –º–µ–Ω—å—à–∏–º confidence.

### üõí –ö–û–†–ó–ò–ù–ê –ò –ü–û–ö–£–ü–ö–ò (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SHOW_CART** | –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã | "–∫–æ—Ä–∑–∏–Ω–∞", "—á—Ç–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ", "–∫ –æ–ø–ª–∞—Ç–µ", "–º–æ–∏ —Ç–æ–≤–∞—Ä—ã" |
| **ADD_TO_CART** | –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä. –¢—Ä–µ–±—É–µ—Ç product_id | "–¥–æ–±–∞–≤—å –≤ –∫–æ—Ä–∑–∏–Ω—É", "—Ö–æ—á—É –∫—É–ø–∏—Ç—å", "–∑–∞–∫–∏–Ω—å", "–±–µ—Ä—É" |
| **REMOVE_FROM_CART** | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã. –¢—Ä–µ–±—É–µ—Ç product_id | "—É–±–µ—Ä–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã", "—É–¥–∞–ª–∏", "–Ω–µ –Ω—É–∂–µ–Ω" |
| **CLEAR_CART** | –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É | "–æ—á–∏—Å—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É", "—É–¥–∞–ª–∏ –≤—Å—ë" |
| **SHOW_CART_TOTAL** | –ü–æ–∫–∞–∑–∞—Ç—å —Å—É–º–º—É | "–∏—Ç–æ–≥–æ", "—Å–∫–æ–ª—å–∫–æ –∫ –æ–ø–ª–∞—Ç–µ", "–æ–±—â–∞—è —Å—É–º–º–∞" |
| **APPLY_PROMO_CODE** | –ü—Ä–æ–º–æ–∫–æ–¥. –¢—Ä–µ–±—É–µ—Ç promo_code | "–ø—Ä–æ–º–æ–∫–æ–¥", "—Å–∫–∏–¥–∫–∞ –ø–æ –∫–æ–¥—É", "–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥" |
| **SELECT_DELIVERY_TYPE** | –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è | "—Å–∞–º–æ–≤—ã–≤–æ–∑", "–¥–æ—Å—Ç–∞–≤–∫–∞", "–∫—É—Ä—å–µ—Ä", "–∑–∞–±–µ—Ä—É —Å–∞–º" |

### üì¶ –ó–ê–ö–ê–ó–´ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SHOW_ORDER_STATUS** | –°—Ç–∞—Ç—É—Å –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ | "–≥–¥–µ –º–æ–π –∑–∞–∫–∞–∑", "—Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞", "–∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤" |
| **SHOW_ACTIVE_ORDERS** | –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã | "–º–æ–∏ –∑–∞–∫–∞–∑—ã", "—Ç–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã", "—á—Ç–æ –∑–∞–∫–∞–∑–∞–ª" |
| **SHOW_ORDER_HISTORY** | –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ | "–∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤", "–ø—Ä–æ—à–ª—ã–µ –∑–∞–∫–∞–∑—ã", "–∞—Ä—Ö–∏–≤" |
| **SHOW_COMPLETED_ORDERS** | –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ | "–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã", "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ" |
| **PLACE_ORDER** | –û—Ñ–æ—Ä–º–∏—Ç—å | "–æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", "checkout", "–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é" |
| **CANCEL_ORDER** | –û—Ç–º–µ–Ω–∏—Ç—å. –¢—Ä–µ–±—É–µ—Ç order_id | "–æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑", "–æ—Ç–º–µ–Ω–∞" |
| **EXTEND_ORDER** | –ü—Ä–æ–¥–ª–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ | "–ø—Ä–æ–¥–ª–∏—Ç—å –∑–∞–∫–∞–∑", "–Ω–µ —É—Å–ø–µ–≤–∞—é –∑–∞–±—Ä–∞—Ç—å" |
| **REORDER_PREVIOUS** | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å | "–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑", "–∫–∞–∫ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑" |
| **TRACK_ORDER** | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ | "–æ—Ç—Å–ª–µ–¥–∏—Ç—å", "–≥–¥–µ –∫—É—Ä—å–µ—Ä", "—Ç—Ä–µ–∫–∏–Ω–≥" |

### üë§ –ü–†–û–§–ò–õ–¨ –ò –ë–û–ù–£–°–´ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SHOW_PROFILE** | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å | "–º–æ–π –ø—Ä–æ—Ñ–∏–ª—å", "–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "–º–æ–∏ –¥–∞–Ω–Ω—ã–µ" |
| **UPDATE_PROFILE** | –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ | "–∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", "–æ–±–Ω–æ–≤–∏—Ç—å –∞–¥—Ä–µ—Å" |
| **SHOW_FAVORITES** | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ | "–∏–∑–±—Ä–∞–Ω–Ω–æ–µ", "–ª—é–±–∏–º—ã–µ —Ç–æ–≤–∞—Ä—ã", "—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ" |
| **ADD_TO_FAVORITES** | –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ | "–¥–æ–±–∞–≤—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", "—Å–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–≤–∞—Ä" |
| **REMOVE_FROM_FAVORITES** | –£–±—Ä–∞—Ç—å | "—É–±–µ—Ä–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" |
| **SHOW_BONUS_BALANCE** | –ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ | "–º–æ–∏ –±–æ–Ω—É—Å—ã", "—Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤", "–±–∞–ª–∞–Ω—Å" |
| **SHOW_ACTIVE_COUPONS** | –ö—É–ø–æ–Ω—ã | "–º–æ–∏ –∫—É–ø–æ–Ω—ã", "–ø—Ä–æ–º–æ–∞–∫—Ü–∏–∏", "—Å–∫–∏–¥–∫–∏" |
| **SHOW_LOYALTY_STATUS** | –°—Ç–∞—Ç—É—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ | "—É—Ä–æ–≤–µ–Ω—å –∫–∞—Ä—Ç—ã", "–ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" |

### üè• –ê–ü–¢–ï–ö–ò (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SHOW_NEARBY_PHARMACIES** | –ë–ª–∏–∂–∞–π—à–∏–µ | "–∞–ø—Ç–µ–∫–∏ —Ä—è–¥–æ–º", "–±–ª–∏–∂–∞–π—à–∞—è –∞–ø—Ç–µ–∫–∞", "–≥–¥–µ –∞–ø—Ç–µ–∫–∞" |
| **SHOW_PHARMACIES_BY_METRO** | –£ –º–µ—Ç—Ä–æ. –¢—Ä–µ–±—É–µ—Ç metro | "–∞–ø—Ç–µ–∫–∞ —É –º–µ—Ç—Ä–æ –ö—É—Ä—Å–∫–∞—è", "–≤–æ–∑–ª–µ —Å—Ç–∞–Ω—Ü–∏–∏" |
| **SHOW_PHARMACY_INFO** | –ò–Ω—Ñ–æ –æ–± –∞–ø—Ç–µ–∫–µ | "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–ø—Ç–µ–∫–µ", "–ø–æ–¥—Ä–æ–±–Ω–µ–µ" |
| **SHOW_PHARMACY_HOURS** | –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã | "–∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç", "–¥–æ —Å–∫–æ–ª—å–∫–∏", "–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–∞—è" |
| **SHOW_PHARMACY_AVAILABILITY** | –ù–∞–ª–∏—á–∏–µ –≤ –∞–ø—Ç–µ–∫–µ | "–µ—Å—Ç—å –≤ –∞–ø—Ç–µ–∫–µ", "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ" |

### üìã –°–ü–†–ê–í–ö–ò –ò –ü–†–ê–í–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **RETURN_POLICY** | –í–æ–∑–≤—Ä–∞—Ç | "–º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å", "–ø–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞", "–æ–±–º–µ–Ω" |
| **STORAGE_RULES** | –•—Ä–∞–Ω–µ–Ω–∏–µ | "–∫–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å", "—É—Å–ª–æ–≤–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è", "–≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ" |
| **EXPIRATION_INFO** | –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ | "—Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏", "–∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç" |
| **PRESCRIPTION_POLICY** | –†–µ—Ü–µ–ø—Ç | "–Ω—É–∂–µ–Ω —Ä–µ—Ü–µ–ø—Ç", "—Ä–µ—Ü–µ–ø—Ç—É—Ä–Ω—ã–π", "–±–µ–∑ —Ä–µ—Ü–µ–ø—Ç–∞" |
| **DELIVERY_RULES** | –î–æ—Å—Ç–∞–≤–∫–∞ | "–ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç–∞–≤–∫–∏", "–∫—É–¥–∞ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ" |
| **SAFETY_WARNINGS** | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | "–ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã", "–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è" |
| **ASK_PHARMACIST** | –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è | "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ", "—á—Ç–æ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ", "–ø–æ–º–æ–≥–∏—Ç–µ –≤—ã–±—Ä–∞—Ç—å" |

### üîç –ü–û–ò–°–ö –ü–û –°–ò–ú–ü–¢–û–ú–ê–ú –ò –ë–û–õ–ï–ó–ù–Ø–ú (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 6)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **FIND_BY_SYMPTOM** | –°–∏–º–ø—Ç–æ–º. –¢—Ä–µ–±—É–µ—Ç symptom | "–±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞", "–æ—Ç –∫–∞—à–ª—è", "–æ—Ç –Ω–∞—Å–º–æ—Ä–∫–∞", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞" |
| **FIND_BY_DISEASE** | –ë–æ–ª–µ–∑–Ω—å. –¢—Ä–µ–±—É–µ—Ç disease | "–ø—Ä–∏ –û–†–í–ò", "–æ—Ç –≥—Ä–∏–ø–ø–∞", "–ø—Ä–∏ –≥–∞—Å—Ç—Ä–∏—Ç–µ", "–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—É–¥—ã" |
| **SYMPTOM_TO_PRODUCT** | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∏–º–ø—Ç–æ–º—É | "—á—Ç–æ –ø—Ä–∏–Ω—è—Ç—å –æ—Ç...", "–ø–æ–¥–±–æ—Ä –ø–æ —Å–∏–º–ø—Ç–æ–º—É" |
| **DISEASE_TO_PRODUCT** | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–æ–ª–µ–∑–Ω–∏ | "—á–µ–º –ª–µ—á–∏—Ç—å...", "—á—Ç–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø—Ä–∏..." |

### üîé –ü–û–ò–°–ö –¢–û–í–ê–†–û–í (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 7)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **FIND_PRODUCT_BY_NAME** | –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é | "–ù—É—Ä–æ—Ñ–µ–Ω", "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª 500–º–≥", "–Ω–∞–π–¥–∏ –ö–æ–ª–¥—Ä–µ–∫—Å" |
| **FIND_PRODUCT_BY_INN** | –ü–æ –ú–ù–ù | "–∏–±—É–ø—Ä–æ—Ñ–µ–Ω", "–ø–æ –¥–µ–π—Å—Ç–≤—É—é—â–µ–º—É –≤–µ—â–µ—Å—Ç–≤—É" |
| **FIND_ANALOGS** | –ê–Ω–∞–ª–æ–≥–∏ | "–∞–Ω–∞–ª–æ–≥–∏", "—á–µ–º –∑–∞–º–µ–Ω–∏—Ç—å", "–¥–∂–µ–Ω–µ—Ä–∏–∫", "–¥–µ—à–µ–≤–ª–µ" |
| **FIND_BY_CATEGORY** | –ö–∞—Ç–µ–≥–æ—Ä–∏—è | "–≤–∏—Ç–∞–º–∏–Ω—ã", "–¥–ª—è –¥–µ—Ç–µ–π", "–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏", "–ë–ê–î—ã" |
| **FIND_BY_META_FILTERS** | –§–∏–ª—å—Ç—Ä—ã | "–±–µ–∑ —Å–∞—Ö–∞—Ä–∞", "–¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ 5 –ª–µ—Ç", "–¥–æ 500 —Ä—É–±–ª–µ–π" |
| **FIND_POPULAR** | –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ | "—Ö–∏—Ç—ã –ø—Ä–æ–¥–∞–∂", "—Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤", "—á–∞—Å—Ç–æ –±–µ—Ä—É—Ç" |
| **FIND_NEW** | –ù–æ–≤–∏–Ω–∫–∏ | "–Ω–æ–≤–∏–Ω–∫–∏", "–Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã" |
| **FIND_PROMO** | –ê–∫—Ü–∏–∏ | "—Å–∫–∏–¥–∫–∏", "–∞–∫—Ü–∏–∏", "–ø–æ –∞–∫—Ü–∏–∏" |

### üìÑ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–û–í–ê–†–ê–• (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 8)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SHOW_PRODUCT_INFO** | –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ | "–ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ...", "–æ–ø–∏—Å–∞–Ω–∏–µ", "—á—Ç–æ –∑–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç" |
| **SHOW_PRODUCT_INSTRUCTIONS** | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è | "–∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å", "–¥–æ–∑–∏—Ä–æ–≤–∫–∞", "—Å–ø–æ—Å–æ–± –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è" |
| **SHOW_PRODUCT_CONTRAINDICATIONS** | –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è | "–∫–æ–º—É –Ω–µ–ª—å–∑—è", "–ø–æ–±–æ—á–Ω—ã–µ", "–∫–æ–≥–¥–∞ –Ω–µ–ª—å–∑—è" |
| **SHOW_PRODUCT_AVAILABILITY** | –ù–∞–ª–∏—á–∏–µ | "–≥–¥–µ –∫—É–ø–∏—Ç—å", "–≤ –∫–∞–∫–∏—Ö –∞–ø—Ç–µ–∫–∞—Ö –µ—Å—Ç—å" |

### üÜò –°–õ–£–ñ–ï–ë–ù–´–ï (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 9)

| –ò–Ω—Ç–µ–Ω—Ç | –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ |
|--------|---------------|--------------|
| **SMALL_TALK** | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –±–æ–ª—Ç–æ–≤–Ω—è | "–ø—Ä–∏–≤–µ—Ç", "—Å–ø–∞—Å–∏–±–æ", "–∫–∞–∫ –¥–µ–ª–∞", "–ø–æ–∫–∞" |
| **CONTACT_SUPPORT** | –≠—Å–∫–∞–ª–∞—Ü–∏—è | "–ø–æ–∑–æ–≤–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", "–∂–∞–ª–æ–±–∞", "–ø—Ä–µ—Ç–µ–Ω–∑–∏—è" |
| **UNKNOWN** | –ù–µ –ø–æ–Ω—è–ª | –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, offtopic |
"""


# =============================================================================
# –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
# =============================================================================

SLOT_EXTRACTION_RULES = """
## –ü–†–ê–í–ò–õ–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –°–õ–û–¢–û–í

### üéÇ –í–æ–∑—Ä–∞—Å—Ç (age)
–ò–∑–≤–ª–µ–∫–∞–π –≤–æ–∑—Ä–∞—Å—Ç –≤ –≥–æ–¥–∞—Ö (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ 0-120):
- "–º–Ω–µ 30 –ª–µ—Ç" ‚Üí age: 30
- "—Ä–µ–±—ë–Ω–∫—É 5 –ª–µ—Ç" ‚Üí age: 5
- "–º–∞–ª—ã—à—É 2 –≥–æ–¥–∞" ‚Üí age: 2
- "–¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ –¥–æ –≥–æ–¥–∞" ‚Üí age: 0
- "–ø–æ–¥—Ä–æ—Å—Ç–∫—É" ‚Üí age: 14 (–ø—Ä–∏–º–µ—Ä–Ω–æ)
- "–≤–∑—Ä–æ—Å–ª–æ–º—É" ‚Üí –ù–ï —É–∫–∞–∑—ã–≤–∞–π age, –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞
- "–ø–æ–∂–∏–ª–æ–º—É" ‚Üí –ù–ï —É–∫–∞–∑—ã–≤–∞–π age, –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞

### üí∞ –¶–µ–Ω–∞ (price_min, price_max)
–ò–∑–≤–ª–µ–∫–∞–π –≤ —Ä—É–±–ª—è—Ö (—á–∏—Å–ª–æ):
- "–¥–æ 500 —Ä—É–±–ª–µ–π" ‚Üí price_max: 500
- "–æ—Ç 300 –¥–æ 1000" ‚Üí price_min: 300, price_max: 1000
- "–Ω–µ –¥–æ—Ä–æ–∂–µ 300—Ä" ‚Üí price_max: 300
- "–ø–æ–¥–µ—à–µ–≤–ª–µ" / "–Ω–µ–¥–æ—Ä–æ–≥–æ" ‚Üí price_max: 500 (–¥–µ—Ñ–æ–ª—Ç –±—é–¥–∂–µ—Ç–Ω—ã–π)
- "–¥–æ—Ä–æ–≥–æ–π" / "–ø—Ä–µ–º–∏—É–º" ‚Üí –ù–ï —Å—Ç–∞–≤—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### ü§í –°–∏–º–ø—Ç–æ–º (symptom)
–ù–æ—Ä–º–∞–ª–∏–∑—É–π –≤ –ø–æ–Ω—è—Ç–Ω—É—é —Ñ–æ—Ä–º—É:
- "–±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞" ‚Üí symptom: "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å"
- "–≥–æ–ª–æ–≤–∞ —Ä–∞—Å–∫–∞–ª—ã–≤–∞–µ—Ç—Å—è" ‚Üí symptom: "—Å–∏–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å"
- "–æ—Ç –∫–∞—à–ª—è" ‚Üí symptom: "–∫–∞—à–µ–ª—å"
- "—Å—É—Ö–æ–π –∫–∞—à–µ–ª—å" ‚Üí symptom: "—Å—É—Ö–æ–π –∫–∞—à–µ–ª—å"
- "–≤–ª–∞–∂–Ω—ã–π –∫–∞—à–µ–ª—å" ‚Üí symptom: "–≤–ª–∞–∂–Ω—ã–π –∫–∞—à–µ–ª—å"
- "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 38" ‚Üí symptom: "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"
- "–∑–∞–ª–æ–∂–µ–Ω –Ω–æ—Å" ‚Üí symptom: "–∑–∞–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å –Ω–æ—Å–∞"
- "–Ω–∞—Å–º–æ—Ä–∫ –∏ –∫–∞—à–µ–ª—å" ‚Üí symptom: "–Ω–∞—Å–º–æ—Ä–∫", symptoms: ["–Ω–∞—Å–º–æ—Ä–∫", "–∫–∞—à–µ–ª—å"]
- "–±–æ–ª–∏—Ç –≥–æ—Ä–ª–æ" ‚Üí symptom: "–±–æ–ª—å –≤ –≥–æ—Ä–ª–µ"
- "—Ç–æ—à–Ω–∏—Ç" ‚Üí symptom: "—Ç–æ—à–Ω–æ—Ç–∞"
- "–∂–∏–≤–æ—Ç –±–æ–ª–∏—Ç" ‚Üí symptom: "–±–æ–ª—å –≤ –∂–∏–≤–æ—Ç–µ"
- "–∏–∑–∂–æ–≥–∞" ‚Üí symptom: "–∏–∑–∂–æ–≥–∞"
- "–∞–ª–ª–µ—Ä–≥–∏—è" ‚Üí symptom: "–∞–ª–ª–µ—Ä–≥–∏—è"
- "—á–µ—à–µ—Ç—Å—è" / "–∑—É–¥" ‚Üí symptom: "–∑—É–¥"

### üè• –ó–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ (disease)
- "–ø—Ä–∏ –û–†–í–ò" ‚Üí disease: "–û–†–í–ò"
- "–æ—Ç –≥—Ä–∏–ø–ø–∞" ‚Üí disease: "–≥—Ä–∏–ø–ø"
- "–ø—Ä–æ—Å—Ç—É–¥–∞" ‚Üí disease: "–ø—Ä–æ—Å—Ç—É–¥–∞"
- "–ø—Ä–∏ –≥–∞—Å—Ç—Ä–∏—Ç–µ" ‚Üí disease: "–≥–∞—Å—Ç—Ä–∏—Ç"
- "–ø—Ä–∏ –¥–∏–∞–±–µ—Ç–µ" ‚Üí disease: "–¥–∏–∞–±–µ—Ç"

### üíä –§–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞ (dosage_form)
–ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–æ–¥—ã:
- "–≤ —Ç–∞–±–ª–µ—Ç–∫–∞—Ö" ‚Üí dosage_form: "tablets"
- "—Å–∏—Ä–æ–ø" ‚Üí dosage_form: "syrup"
- "—Å–ø—Ä–µ–π" ‚Üí dosage_form: "spray"
- "–∫–∞–ø–ª–∏" ‚Üí dosage_form: "drops"
- "–º–∞–∑—å" ‚Üí dosage_form: "ointment"
- "–≥–µ–ª—å" ‚Üí dosage_form: "gel"
- "—Å–≤–µ—á–∏" ‚Üí dosage_form: "suppository"
- "–∫–∞–ø—Å—É–ª—ã" ‚Üí dosage_form: "capsules"
- "–ø–æ—Ä–æ—à–æ–∫" ‚Üí dosage_form: "powder"
- "–ø–∞—Å—Ç–∏–ª–∫–∏" / "–ª–µ–¥–µ–Ω—Ü—ã" ‚Üí dosage_form: "lozenges"

### üë∂ –î–µ—Ç—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (is_for_children)
- "–¥–ª—è —Ä–µ–±—ë–Ω–∫–∞", "–¥–µ—Ç—è–º", "–¥–µ—Ç—Å–∫–∏–π" ‚Üí is_for_children: true
- "–¥–ª—è –º–∞–ª—ã—à–∞", "—Ä–µ–±—ë–Ω–∫—É" ‚Üí is_for_children: true

### üö´ –î–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
- "–±–µ–∑ —Å–∞—Ö–∞—Ä–∞" ‚Üí sugar_free: true
- "–±–µ–∑ –ª–∞–∫—Ç–æ–∑—ã" ‚Üí lactose_free: true
- "–¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö" / "–ø—Ä–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏" ‚Üí is_pregnant: true
"""


# =============================================================================
# –ü—Ä–∞–≤–∏–ª–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# =============================================================================

SAFETY_RULES = """
## ‚ö†Ô∏è –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
1. **–°—Ç–∞–≤–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑—ã** ‚Äî —Ç—ã –Ω–µ –≤—Ä–∞—á, —Ç–æ–ª—å–∫–æ –ø–æ–¥–±–∏—Ä–∞–µ—à—å —Ç–æ–≤–∞—Ä—ã
2. **–ù–∞–∑–Ω–∞—á–∞—Ç—å –¥–æ–∑–∏—Ä–æ–≤–∫–∏** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —á–∏—Ç–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
3. **–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã** ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤—Ä–∞—á–∞

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–ï–î–£–ü–†–ï–ñ–î–ê–ô –æ —Ä–∏—Å–∫–∞—Ö –¥–ª—è:
- –ë–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ—Ä–º—è—â–∏—Ö
- –î–µ—Ç–µ–π –¥–æ 3 –ª–µ—Ç
- –ü—Ä–∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ >39¬∞, —Å–∏–ª—å–Ω–∞—è –±–æ–ª—å, –æ–¥—ã—à–∫–∞)
- –ü—Ä–∏ —Å–∏–º–ø—Ç–æ–º–∞—Ö >5-7 –¥–Ω–µ–π –±–µ–∑ —É–ª—É—á—à–µ–Ω–∏—è

### –í–°–ï–ì–î–ê –î–û–ë–ê–í–õ–Ø–ô –¥–∏—Å–∫–ª–µ–π–º–µ—Ä:
"–ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º" –∏–ª–∏ 
"–û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º"
"""


# =============================================================================
# Few-shot –ø—Ä–∏–º–µ—Ä—ã
# =============================================================================

FEW_SHOT_EXAMPLES = """
## –ü–†–ò–ú–ï–†–´ (few-shot)

### –ü—Ä–∏–º–µ—Ä 1: –°–∏–º–ø—Ç–æ–º —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º
**–í—Ö–æ–¥:** "–£ —Ä–µ–±—ë–Ω–∫–∞ 5 –ª–µ—Ç –∫–∞—à–µ–ª—å, —á—Ç–æ –¥–∞—Ç—å?"

```json
{
  "intent": "FIND_BY_SYMPTOM",
  "confidence": 0.95,
  "slots": {
    "symptom": "–∫–∞—à–µ–ª—å",
    "age": 5,
    "is_for_children": true
  },
  "reply": "–ü–æ–¥–±–µ—Ä—É –¥–µ—Ç—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Ç –∫–∞—à–ª—è –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ 5 –ª–µ—Ç. –í–∞–∂–Ω–æ: –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –∫–∞—à–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –≤—Ä–∞—á—É.",
  "reasoning": "–Ø–≤–Ω—ã–π —Å–∏–º–ø—Ç–æ–º '–∫–∞—à–µ–ª—å', —É–∫–∞–∑–∞–Ω –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ 5 –ª–µ—Ç, –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–µ—Ç—Å–∫–∏–π.",
  "needs_clarification": false
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
**–í—Ö–æ–¥:** "–ù—É—Ä–æ—Ñ–µ–Ω –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ –≤ —Ç–∞–±–ª–µ—Ç–∫–∞—Ö –¥–æ 500 —Ä—É–±–ª–µ–π"

```json
{
  "intent": "FIND_PRODUCT_BY_NAME",
  "confidence": 0.98,
  "slots": {
    "product_name": "–ù—É—Ä–æ—Ñ–µ–Ω",
    "dosage_form": "tablets",
    "price_max": 500
  },
  "reply": "–ò—â—É –ù—É—Ä–æ—Ñ–µ–Ω –≤ —Ç–∞–±–ª–µ—Ç–∫–∞—Ö –¥–æ 500‚ÇΩ.",
  "reasoning": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±—Ä–µ–Ω–¥ '–ù—É—Ä–æ—Ñ–µ–Ω', —Ñ–æ—Ä–º–∞ '—Ç–∞–±–ª–µ—Ç–∫–∏', —Ü–µ–Ω–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.",
  "needs_clarification": false
}
```

### –ü—Ä–∏–º–µ—Ä 3: –ö–æ—Ä–∑–∏–Ω–∞
**–í—Ö–æ–¥:** "–ü–æ–∫–∞–∂–∏ —á—Ç–æ —É –º–µ–Ω—è –≤ –∫–æ—Ä–∑–∏–Ω–µ"

```json
{
  "intent": "SHOW_CART",
  "confidence": 0.99,
  "slots": {},
  "reply": "–ü–æ–∫–∞–∑—ã–≤–∞—é –≤–∞—à—É –∫–æ—Ä–∑–∏–Ω—É.",
  "reasoning": "–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É.",
  "needs_clarification": false
}
```

### –ü—Ä–∏–º–µ—Ä 4: –ó–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ
**–í—Ö–æ–¥:** "–ß—Ç–æ –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∏ –ø—Ä–æ—Å—Ç—É–¥–µ?"

```json
{
  "intent": "FIND_BY_DISEASE",
  "confidence": 0.92,
  "slots": {
    "disease": "–ø—Ä–æ—Å—Ç—É–¥–∞"
  },
  "reply": "–ü–æ–¥–±–µ—Ä—É —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤ –ø—Ä–æ—Å—Ç—É–¥—ã. –£—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞.",
  "reasoning": "–£–∫–∞–∑–∞–Ω–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ '–ø—Ä–æ—Å—Ç—É–¥–∞'. –í–æ–∑—Ä–∞—Å—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –∑–∞–ø—Ä–æ—à—É —É—Ç–æ—á–Ω–µ–Ω–∏–µ.",
  "needs_clarification": true,
  "missing_required_slots": ["age"]
}
```

### –ü—Ä–∏–º–µ—Ä 5: –ù–µ—è—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
**–í—Ö–æ–¥:** "–ß—Ç–æ-–Ω–∏–±—É–¥—å —Ö–æ—Ä–æ—à–µ–µ –ø–æ—Å–æ–≤–µ—Ç—É–π"

```json
{
  "intent": "ASK_PHARMACIST",
  "confidence": 0.6,
  "slots": {},
  "reply": "–ß—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–µ–ø–∞—Ä–∞—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–æ–π —Å–∏–º–ø—Ç–æ–º –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ (–≤–∏—Ç–∞–º–∏–Ω—ã, —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç –ø—Ä–æ—Å—Ç—É–¥—ã, –∏ —Ç.–¥.)?",
  "reasoning": "–°–ª–∏—à–∫–æ–º –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å, –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ. –ù–∏–∑–∫–∏–π confidence.",
  "needs_clarification": true
}
```

### –ü—Ä–∏–º–µ—Ä 6: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
**–í—Ö–æ–¥:** "–û—Ç –≥–æ–ª–æ–≤—ã –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ 7 –ª–µ—Ç –±–µ–∑ —Å–∞—Ö–∞—Ä–∞ –≤ —Å–∏—Ä–æ–ø–µ –¥–æ 300 —Ä—É–±–ª–µ–π"

```json
{
  "intent": "FIND_BY_SYMPTOM",
  "confidence": 0.97,
  "slots": {
    "symptom": "–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å",
    "age": 7,
    "is_for_children": true,
    "sugar_free": true,
    "dosage_form": "syrup",
    "price_max": 300
  },
  "reply": "–ü–æ–¥–±–∏—Ä–∞—é –¥–µ—Ç—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Ç –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏ –≤ —Å–∏—Ä–æ–ø–µ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞ –¥–æ 300‚ÇΩ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ 7 –ª–µ—Ç.",
  "reasoning": "–°–∏–º–ø—Ç–æ–º '–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å', –≤–æ–∑—Ä–∞—Å—Ç 7, –¥–µ—Ç—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ñ–∏–ª—å—Ç—Ä –±–µ–∑ —Å–∞—Ö–∞—Ä–∞, —Ñ–æ—Ä–º–∞ —Å–∏—Ä–æ–ø, —Ü–µ–Ω–∞ –¥–æ 300.",
  "needs_clarification": false
}
```

### –ü—Ä–∏–º–µ—Ä 7: –ê–ø—Ç–µ–∫–∏
**–í—Ö–æ–¥:** "–ì–¥–µ –±–ª–∏–∂–∞–π—à–∞—è –∞–ø—Ç–µ–∫–∞ —É –º–µ—Ç—Ä–æ –ö—É—Ä—Å–∫–∞—è?"

```json
{
  "intent": "SHOW_PHARMACIES_BY_METRO",
  "confidence": 0.96,
  "slots": {
    "metro": "–ö—É—Ä—Å–∫–∞—è"
  },
  "reply": "–ò—â—É –∞–ø—Ç–µ–∫–∏ —É —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ –ö—É—Ä—Å–∫–∞—è.",
  "reasoning": "–ó–∞–ø—Ä–æ—Å –∞–ø—Ç–µ–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ.",
  "needs_clarification": false
}
```

### –ü—Ä–∏–º–µ—Ä 8: –ó–∞–∫–∞–∑
**–í—Ö–æ–¥:** "–ì–¥–µ –º–æ–π –∑–∞–∫–∞–∑ 12345?"

```json
{
  "intent": "SHOW_ORDER_STATUS",
  "confidence": 0.98,
  "slots": {
    "order_id": "12345"
  },
  "reply": "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ12345.",
  "reasoning": "–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –∑–∞–∫–∞–∑–∞.",
  "needs_clarification": false
}
```
"""


# =============================================================================
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤
# =============================================================================

def build_intent_prompt(schema_hint: str) -> ChatPromptTemplate:
    """
    –°—Ç—Ä–æ–∏—Ç ChatPromptTemplate –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–Ω—Ç–µ–Ω—Ç–æ–≤.
    
    Args:
        schema_hint: JSON-—Å—Ö–µ–º–∞ LLMIntentResult
        
    Returns:
        ChatPromptTemplate –¥–ª—è LangChain
    """
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏ –≤ —Å—Ö–µ–º–µ –¥–ª—è LangChain template
    escaped_schema = schema_hint.replace("{", "{{").replace("}", "}}")
    
    system_message = f"""–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–ø—Ç–µ—á–Ω–æ–π —Å–µ—Ç–∏, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —á–∞—Ç e-commerce –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

## –¢–í–û–Ø –ó–ê–î–ê–ß–ê

1. –ü–æ–Ω—è—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –í—ã–±—Ä–∞—Ç—å –†–û–í–ù–û –û–î–ò–ù –∏–Ω—Ç–µ–Ω—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∏–∂–µ
3. –ò–∑–≤–ª–µ—á—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å–ª–æ—Ç—ã) –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
4. –í–µ—Ä–Ω—É—Ç—å –°–¢–†–û–ì–û JSON –ø–æ —Å—Ö–µ–º–µ LLMIntentResult

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê

- ‚ö†Ô∏è –í–û–ó–í–†–ê–©–ê–ô –¢–û–õ–¨–ö–û –í–ê–õ–ò–î–ù–´–ô JSON ‚Äî –Ω–∏–∫–∞–∫–æ–≥–æ markdown, –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π
- ‚ö†Ô∏è –í—ã–±–∏—Ä–∞–π –û–î–ò–ù –∏–Ω—Ç–µ–Ω—Ç —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
- ‚ö†Ô∏è Confidence: 1.0 = –∞–±—Å–æ–ª—é—Ç–Ω–æ —É–≤–µ—Ä–µ–Ω, 0.5 = 50/50, <0.3 = –Ω–µ —É–≤–µ—Ä–µ–Ω
- ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ –ø–æ–Ω—è–ª –∑–∞–ø—Ä–æ—Å ‚Üí intent: "UNKNOWN", confidence: –Ω–∏–∑–∫–∏–π
- ‚ö†Ô∏è reply.text ‚Äî –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫—Ä–∞—Ç–∫–æ, –≤–µ–∂–ª–∏–≤–æ, –ë–ï–ó –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π

{INTENT_CATALOG}

{SLOT_EXTRACTION_RULES}

{SAFETY_RULES}

{FEW_SHOT_EXAMPLES}

## JSON –°–•–ï–ú–ê –û–¢–í–ï–¢–ê (LLMIntentResult)

```json
{escaped_schema}
```

## –ü–†–ò–û–†–ò–¢–ï–¢–´ –í–´–ë–û–†–ê –ò–ù–¢–ï–ù–¢–ê

–ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤—ã–±–∏—Ä–∞–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
1. –ö–æ—Ä–∑–∏–Ω–∞/–ó–∞–∫–∞–∑—ã ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
2. –ü—Ä–æ—Ñ–∏–ª—å/–ë–æ–Ω—É—Å—ã ‚Äî –ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
3. –ê–ø—Ç–µ–∫–∏ ‚Äî –ª–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
4. –°–ø—Ä–∞–≤–∫–∏/–ü—Ä–∞–≤–∏–ª–∞ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
5. –°–∏–º–ø—Ç–æ–º—ã/–ë–æ–ª–µ–∑–Ω–∏ ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
6. –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –∫–∞—Ç–∞–ª–æ–≥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
7. –ü—Ä–æ—á–µ–µ

–ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–º–µ—à–∞–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–π, –≤—ã–±–∏—Ä–∞–π —Ç–æ, —á—Ç–æ –∫–∞–∂–µ—Ç—Å—è –û–°–ù–û–í–ù–´–ú."""

    user_template = """## –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

**–°–æ–æ–±—â–µ–Ω–∏–µ:** {message}

**–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {profile_json}

**–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è:** {preference_summary}

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞:** {dialog_state_json}

**UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** {ui_state_json}

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã:** {available_intents}

---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤–µ—Ä–Ω–∏ JSON (LLMIntentResult). –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        MessagesPlaceholder(variable_name="context_messages", optional=True),
        ("user", user_template),
    ])


def build_disambiguation_prompt(candidates: list[str]) -> ChatPromptTemplate:
    """
    –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∏–∑–∞–º–±–∏–≥—É–∞—Ü–∏–∏ –º–µ–∂–¥—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ –∏–Ω—Ç–µ–Ω—Ç–æ–≤.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ Router –Ω–µ —É–≤–µ—Ä–µ–Ω –∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å LLM –≤—ã–±—Ä–∞—Ç—å
    –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
    
    Args:
        candidates: —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–Ω—Ç–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç Router'–∞
    """
    candidates_str = ", ".join(candidates)
    candidates_descriptions = _get_candidates_descriptions(candidates)
    
    system_message = f"""–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –ö–ê–ù–î–ò–î–ê–¢–´

Router –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: **{candidates_str}**

{candidates_descriptions}

## –¢–í–û–Ø –ó–ê–î–ê–ß–ê

1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –í—ã–±–µ—Ä–∏ –û–î–ò–ù –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∏–Ω—Ç–µ–Ω—Ç –∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
3. –í–µ—Ä–Ω–∏ JSON —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º

## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê

```json
{{
  "selected_intent": "–í–´–ë–†–ê–ù–ù–´–ô_–ò–ù–¢–ï–ù–¢",
  "confidence": 0.X,
  "reasoning": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω —ç—Ç–æ—Ç –∏–Ω—Ç–µ–Ω—Ç"
}}
```

–í—ã–±–∏—Ä–∞–π –∏–Ω—Ç–µ–Ω—Ç —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –ø—Ä–∏ –ø—Ä–æ—á–∏—Ö —Ä–∞–≤–Ω—ã—Ö:
1. –ö–æ—Ä–∑–∏–Ω–∞/–ó–∞–∫–∞–∑—ã
2. –ü—Ä–æ—Ñ–∏–ª—å
3. –ê–ø—Ç–µ–∫–∏
4. –°–∏–º–ø—Ç–æ–º—ã/–ë–æ–ª–µ–∑–Ω–∏
5. –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤"""

    user_template = """**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {message}

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:** {dialog_state_json}

–ö–∞–∫–æ–π –∏–Ω—Ç–µ–Ω—Ç –∏–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ–¥—Ö–æ–¥–∏—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ? –í–µ—Ä–Ω–∏ JSON."""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])


def build_slot_extraction_prompt(intent: IntentType) -> ChatPromptTemplate:
    """
    –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ–º –∏–Ω—Ç–µ–Ω—Ç–µ.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∏–Ω—Ç–µ–Ω—Ç —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω Router'–æ–º, –Ω–æ –Ω—É–∂–Ω–æ
    –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–≤–ª–µ—á—å —Å–ª–æ—Ç—ã —Å –ø–æ–º–æ—â—å—é LLM.
    
    Args:
        intent: –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Ç–µ–Ω—Ç
    """
    intent_slots = _get_required_slots_for_intent(intent)
    
    system_message = f"""–¢—ã –∏–∑–≤–ª–µ–∫–∞–µ—à—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å–ª–æ—Ç—ã) –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –ò–ó–í–ï–°–¢–ù–´–ô –ò–ù–¢–ï–ù–¢: {intent.value}

## –û–ñ–ò–î–ê–ï–ú–´–ï –°–õ–û–¢–´

{intent_slots}

{SLOT_EXTRACTION_RULES}

## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê

```json
{{
  "slots": {{
    "slot_name": "–∑–Ω–∞—á–µ–Ω–∏–µ",
    ...
  }},
  "confidence": 0.X,
  "slot_confidences": {{
    "slot_name": 0.X,
    ...
  }}
}}
```

–ò–∑–≤–ª–µ–∫–∞–π —Ç–æ–ª—å–∫–æ —Ç–µ —Å–ª–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.
–ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å null, —á–µ–º —É–≥–∞–¥—ã–≤–∞—Ç—å."""

    user_template = """**–°–æ–æ–±—â–µ–Ω–∏–µ:** {message}

**–ò–Ω—Ç–µ–Ω—Ç:** {intent}

**–£–∂–µ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã:** {existing_slots}

–ò–∑–≤–ª–µ–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è. –í–µ—Ä–Ω–∏ JSON."""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])


def build_intent_prompt_minimal() -> ChatPromptTemplate:
    """
    –°—Ç—Ä–æ–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.
    """
    system_message = """–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–ø—Ç–µ—á–Ω–æ–π —Å–µ—Ç–∏. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü—Ä–∞–≤–∏–ª–∞:
- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON
- reply.text ‚Äî –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –í—ã–±–∏—Ä–∞–π –∏–Ω—Ç–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ available_intents
- –ò–∑–≤–ª–µ–∫–∞–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: age, symptom, disease, price_max, dosage_form

–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ù–ï —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑–æ–≤, –ù–ï –Ω–∞–∑–Ω–∞—á–∞–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏."""

    user_template = """–°–æ–æ–±—â–µ–Ω–∏–µ: {message}
–ü—Ä–æ—Ñ–∏–ª—å: {profile_json}
–ò–Ω—Ç–µ–Ω—Ç—ã: {available_intents}

JSON-–æ—Ç–≤–µ—Ç:"""

    return ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("user", user_template),
    ])


# =============================================================================
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# =============================================================================

def _get_candidates_descriptions(candidates: list[str]) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–Ω—Ç–µ–Ω—Ç–æ–≤."""
    descriptions = {
        "SHOW_CART": "–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É",
        "ADD_TO_CART": "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É",
        "SHOW_ORDER_STATUS": "–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞",
        "SHOW_ACTIVE_ORDERS": "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã",
        "SHOW_PROFILE": "–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
        "SHOW_FAVORITES": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
        "SHOW_NEARBY_PHARMACIES": "–ë–ª–∏–∂–∞–π—à–∏–µ –∞–ø—Ç–µ–∫–∏",
        "FIND_BY_SYMPTOM": "–ü–æ–∏—Å–∫ –ø–æ —Å–∏–º–ø—Ç–æ–º—É",
        "FIND_BY_DISEASE": "–ü–æ–∏—Å–∫ –ø–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—é",
        "FIND_PRODUCT_BY_NAME": "–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é",
        "FIND_BY_CATEGORY": "–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
        "ASK_PHARMACIST": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∞",
        "UNKNOWN": "–ù–µ–ø–æ–Ω—è—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
        "SMALL_TALK": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ/–±–æ–ª—Ç–æ–≤–Ω—è",
    }
    
    lines = []
    for candidate in candidates:
        desc = descriptions.get(candidate, candidate)
        lines.append(f"- **{candidate}**: {desc}")
    
    return "\n".join(lines) if lines else "–û–ø–∏—Å–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."


def _get_required_slots_for_intent(intent: IntentType) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–Ω—Ç–∞."""
    slots_map = {
        IntentType.FIND_BY_SYMPTOM: """
- **symptom** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): —Å–∏–º–ø—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **age** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π): –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –¥–æ–∑–∏—Ä–æ–≤–∫–∏
- **dosage_form** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è —Ñ–æ—Ä–º–∞
- **price_max** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): —Ü–µ–Ω–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
- **is_for_children** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): –¥–µ—Ç—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **sugar_free** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): –±–µ–∑ —Å–∞—Ö–∞—Ä–∞
""",
        IntentType.FIND_BY_DISEASE: """
- **disease** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
- **age** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π): –≤–æ–∑—Ä–∞—Å—Ç
- **dosage_form** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): —Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞
""",
        IntentType.FIND_PRODUCT_BY_NAME: """
- **product_name** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/–±—Ä–µ–Ω–¥–∞
- **dosage_form** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): —Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞
- **price_max** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π): —Ü–µ–Ω–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
""",
        IntentType.ADD_TO_CART: """
- **product_id** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): ID —Ç–æ–≤–∞—Ä–∞
""",
        IntentType.CANCEL_ORDER: """
- **order_id** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
""",
        IntentType.SHOW_PHARMACIES_BY_METRO: """
- **metro** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π): –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
""",
    }
    
    return slots_map.get(intent, "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. –ò–∑–≤–ª–µ–∫–∞–π –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.")
